<?php

// Generated by Haxe 3.4.4
class sys_ufront_web_context_HttpRequest extends ufront_web_context_HttpRequest {
	public function __construct() {
		if(!php_Boot::$skip_constructor) {
		$this->_parsed = false;
	}}
	public function get_queryString() {
		if($this->queryString === null) {
			$this->queryString = php_Web::getParamsString();
			if($this->queryString === null) {
				$this->queryString = "";
			}
			$indexOfHash = _hx_index_of($this->queryString, "#", null);
			if($indexOfHash > -1) {
				$this->queryString = _hx_substring($this->queryString, 0, $indexOfHash);
			}
		}
		return $this->queryString;
	}
	public function get_postString() {
		if($this->postString === null) {
			$tmp = null;
			if($this->get_httpMethod() === "GET") {
				$tmp = "";
			} else {
				$tmp = php_Web::getPostData();
			}
			$this->postString = $tmp;
			if($this->postString === null) {
				$this->postString = "";
			}
		}
		return $this->postString;
	}
	public $_parsed;
	public function parseMultipart($onPart = null, $onData = null, $onEndPart = null) {
		$_gthis = $this;
		if(!$this->isMultipart()) {
			return ufront_core_SurpriseTools::success();
		}
		if($this->_parsed) {
			throw new HException(ufront_web_HttpError::internalServerError("parseMultipart() has been called more than once.", null, _hx_anonymous(array("fileName" => "HttpRequest.hx", "lineNumber" => 90, "className" => "sys.ufront.web.context.HttpRequest", "methodName" => "parseMultipart"))));
		}
		$this->_parsed = true;
		if($onPart === null) {
			$onPart = array(new _hx_lambda(array(), "sys_ufront_web_context_HttpRequest_0"), 'execute');
		}
		if($onData === null) {
			$onData = array(new _hx_lambda(array(), "sys_ufront_web_context_HttpRequest_1"), 'execute');
		}
		if($onEndPart === null) {
			$onEndPart = array(new _hx_lambda(array(), "sys_ufront_web_context_HttpRequest_2"), 'execute');
		}
		$this1 = new haxe_ds_StringMap();
		$this->post = $this1;
		$noParts = true;
		$isFile = false;
		$partName = null;
		$fileName = null;
		$currentContent = null;
		$callbackFutures = (new _hx_array(array()));
		$errors = (new _hx_array(array()));
		$processCallbackResult = array(new _hx_lambda(array(&$callbackFutures, &$errors), "sys_ufront_web_context_HttpRequest_3"), 'execute');
		$doEndOfPart = array(new _hx_lambda(array(&$_gthis, &$currentContent, &$isFile, &$onEndPart, &$partName, &$processCallbackResult), "sys_ufront_web_context_HttpRequest_4"), 'execute');
		$doPart = array(new _hx_lambda(array(&$_gthis, &$currentContent, &$doEndOfPart, &$fileName, &$isFile, &$noParts, &$onPart, &$partName, &$processCallbackResult), "sys_ufront_web_context_HttpRequest_5"), 'execute');
		$doData = array(new _hx_lambda(array(&$currentContent, &$isFile, &$onData, &$processCallbackResult), "sys_ufront_web_context_HttpRequest_6"), 'execute');
		try {
			sys_ufront_web_context__HttpRequest_WebOverride::parseMultipart($doPart, $doData);
		}catch(Exception $__hx__e) {
			$_ex_ = ($__hx__e instanceof HException) && $__hx__e->getCode() == null ? $__hx__e->e : $__hx__e;
			$e = $_ex_;
			{
				$stack = haxe_CallStack::toString(haxe_CallStack::exceptionStack());
				$err1 = "Failed to parse multipart data: " . Std::string($e) . "\x0A" . _hx_string_or_null($stack);
				$errors->push($err1);
			}
		}
		if($noParts === false) {
			call_user_func($doEndOfPart);
		}
		if($callbackFutures->length > 0) {
			return tink_core__Future_Future_Impl_::flatMap(tink_core__Future_Future_Impl_::ofMany($callbackFutures, null), array(new _hx_lambda(array(&$errors), "sys_ufront_web_context_HttpRequest_7"), 'execute'), null);
		} else {
			return tink_core__Future_Future_Impl_::sync(tink_core_Outcome::Success(tink_core_Noise::$Noise));
		}
	}
	public function get_query() {
		if($this->query === null) {
			$this->query = sys_ufront_web_context_HttpRequest::getMultiValueMapFromString($this->get_queryString());
		}
		return $this->query;
	}
	public function get_post() {
		if($this->post === null) {
			if($this->get_httpMethod() === "GET") {
				$this1 = new haxe_ds_StringMap();
				$this->post = $this1;
			} else {
				if($this->isMultipart()) {
					if($this->_parsed === false) {
						$this->parseMultipart(null, null, null);
					}
				} else {
					$this->post = sys_ufront_web_context_HttpRequest::getMultiValueMapFromString($this->get_postString());
				}
			}
		}
		return $this->post;
	}
	public function get_cookies() {
		if($this->cookies === null) {
			$this->cookies = ufront_core__MultiValueMap_MultiValueMap_Impl_::fromStringMap(php_Web::getCookies());
		}
		return $this->cookies;
	}
	public function get_hostName() {
		if($this->hostName === null) {
			$this->hostName = $_SERVER['SERVER_NAME'];
		}
		return $this->hostName;
	}
	public function get_clientIP() {
		if($this->clientIP === null) {
			$this->clientIP = $_SERVER['REMOTE_ADDR'];
		}
		return $this->clientIP;
	}
	public function get_uri() {
		if($this->uri === null) {
			$this->uri = php_Web::getURI();
			$s = $this->uri;
			$this->uri = urldecode($s);
		}
		return $this->uri;
	}
	public function get_clientHeaders() {
		if($this->clientHeaders === null) {
			$this1 = null;
			$this2 = new haxe_ds_StringMap();
			$this1 = $this2;
			$this->clientHeaders = $this1;
			$headers = php_Lib::hashOfAssociativeArray(apache_request_headers());
			{
				$name = $headers->keys();
				while($name->hasNext()) {
					$name1 = $name->next();
					$_g = 0;
					$_g1 = _hx_explode(",", $headers->get($name1));
					while($_g < $_g1->length) {
						$val = $_g1[$_g];
						$_g = $_g + 1;
						{
							$this3 = $this->clientHeaders;
							$value = trim($val);
							ufront_core__MultiValueMap_MultiValueMap_Impl_::add($this3, strtolower($name1), $value);
							unset($value,$this3);
						}
						unset($val);
					}
					unset($name1,$_g1,$_g);
				}
			}
		}
		return $this->clientHeaders;
	}
	public function get_httpMethod() {
		if($this->httpMethod === null) {
			$this->httpMethod = php_Web::getMethod();
			if($this->httpMethod === null) {
				$this->httpMethod = "";
			}
		}
		return $this->httpMethod;
	}
	public function get_scriptDirectory() {
		if($this->scriptDirectory === null) {
			$this->scriptDirectory = _hx_string_or_null(dirname($_SERVER["SCRIPT_FILENAME"])) . "/";
		}
		return $this->scriptDirectory;
	}
	public function get_authorization() {
		if(_hx_field($this, "authorization") === null) {
			$this->authorization = php_Web::getAuthorization();
			if(_hx_field($this, "authorization") === null) {
				$this->authorization = _hx_anonymous(array("user" => null, "pass" => null));
			}
		}
		return $this->authorization;
	}
	public function __call($m, $a) {
		if(isset($this->$m) && is_callable($this->$m))
			return call_user_func_array($this->$m, $a);
		else if(isset($this->__dynamics[$m]) && is_callable($this->__dynamics[$m]))
			return call_user_func_array($this->__dynamics[$m], $a);
		else if('toString' == $m)
			return $this->__toString();
		else
			throw new HException('Unable to call <'.$m.'>');
	}
	static function getMultiValueMapFromString($s) {
		$this1 = new haxe_ds_StringMap();
		$map = $this1;
		{
			$_g = 0;
			$_g1 = _hx_explode("&", $s);
			while($_g < $_g1->length) {
				$part = $_g1[$_g];
				$_g = $_g + 1;
				$index = _hx_index_of($part, "=", null);
				if($index > 0) {
					$name = _hx_substr($part, 0, $index);
					$val = _hx_substr($part, $index + 1, null);
					$tmp = urldecode($name);
					ufront_core__MultiValueMap_MultiValueMap_Impl_::add($map, $tmp, urldecode($val));
					unset($val,$tmp,$name);
				}
				unset($part,$index);
			}
		}
		return $map;
	}
	static $__properties__ = array("get_authorization" => "get_authorization","get_scriptDirectory" => "get_scriptDirectory","get_httpMethod" => "get_httpMethod","get_userAgent" => "get_userAgent","get_clientHeaders" => "get_clientHeaders","get_uri" => "get_uri","get_clientIP" => "get_clientIP","get_hostName" => "get_hostName","get_cookies" => "get_cookies","get_files" => "get_files","get_post" => "get_post","get_query" => "get_query","get_postString" => "get_postString","get_queryString" => "get_queryString","get_params" => "get_params");
	function __toString() { return 'sys.ufront.web.context.HttpRequest'; }
}
function sys_ufront_web_context_HttpRequest_0($_, $_1) {
	{
		return tink_core__Future_Future_Impl_::sync(tink_core_Outcome::Success(tink_core_Noise::$Noise));
	}
}
function sys_ufront_web_context_HttpRequest_1($_2, $_3, $_4) {
	{
		return tink_core__Future_Future_Impl_::sync(tink_core_Outcome::Success(tink_core_Noise::$Noise));
	}
}
function sys_ufront_web_context_HttpRequest_2() {
	{
		return tink_core__Future_Future_Impl_::sync(tink_core_Outcome::Success(tink_core_Noise::$Noise));
	}
}
function sys_ufront_web_context_HttpRequest_3(&$callbackFutures, &$errors, $surprise) {
	{
		$callbackFutures->push($surprise);
		call_user_func_array($surprise, array(array(new _hx_lambda(array(&$errors), "sys_ufront_web_context_HttpRequest_8"), 'execute')));
	}
}
function sys_ufront_web_context_HttpRequest_4(&$_gthis, &$currentContent, &$isFile, &$onEndPart, &$partName, &$processCallbackResult) {
	{
		if($isFile) {
			$doEndOfPart1 = call_user_func($onEndPart);
			call_user_func_array($processCallbackResult, array($doEndOfPart1));
		} else {
			if($currentContent !== null) {
				$doEndOfPart2 = $_gthis->get_post();
				ufront_core__MultiValueMap_MultiValueMap_Impl_::add($doEndOfPart2, $partName, $currentContent);
			}
		}
	}
}
function sys_ufront_web_context_HttpRequest_5(&$_gthis, &$currentContent, &$doEndOfPart, &$fileName, &$isFile, &$noParts, &$onPart, &$partName, &$processCallbackResult, $newPartName, $newPartFilename) {
	{
		call_user_func($doEndOfPart);
		$noParts = false;
		$currentContent = null;
		$partName = urldecode($newPartName);
		$isFile = false;
		$doPart1 = null;
		if($newPartFilename !== null) {
			$doPart1 = $newPartFilename !== "";
		} else {
			$doPart1 = false;
		}
		if($doPart1) {
			$fileName = urldecode($newPartFilename);
			$doPart2 = $_gthis->get_post();
			ufront_core__MultiValueMap_MultiValueMap_Impl_::add($doPart2, $partName, $fileName);
			$doPart3 = call_user_func_array($onPart, array($partName, $fileName));
			call_user_func_array($processCallbackResult, array($doPart3));
			$isFile = true;
		}
	}
}
function sys_ufront_web_context_HttpRequest_6(&$currentContent, &$isFile, &$onData, &$processCallbackResult, $bytes, $pos, $len) {
	{
		if($isFile) {
			if($len > 0) {
				$doData1 = call_user_func_array($onData, array($bytes, $pos, $len));
				call_user_func_array($processCallbackResult, array($doData1));
			}
		} else {
			if($currentContent === null) {
				$currentContent = "";
			}
			$currentContent1 = $bytes->getString($pos, $len);
			$currentContent = _hx_string_or_null($currentContent) . _hx_string_or_null($currentContent1);
		}
	}
}
function sys_ufront_web_context_HttpRequest_7(&$errors, $_5) {
	{
		if($errors->length === 0) {
			return tink_core__Future_Future_Impl_::sync(tink_core_Outcome::Success(tink_core_Noise::$Noise));
		} else {
			return tink_core__Future_Future_Impl_::sync(tink_core_Outcome::Failure(tink_core_TypedError::withData(null, "Error parsing multipart request data", $errors, _hx_anonymous(array("fileName" => "HttpRequest.hx", "lineNumber" => 171, "className" => "sys.ufront.web.context.HttpRequest", "methodName" => "parseMultipart")))));
		}
	}
}
function sys_ufront_web_context_HttpRequest_8(&$errors, $outcome) {
	{
		if($outcome->index === 1) {
			$err = _hx_deref($outcome)->params[0];
			$processCallbackResult1 = $err->toString();
			$errors->push($processCallbackResult1);
		}
	}
}
